{% extends "base_generic.html" %}

{% block content %}
<br><br>
<br><br>
<div class="container ">
      <div class="row ">
            {% for p in products %}
            <div class="col-6 col-s-12">
                  <div class="card mx-auto shadow">
                        <div class="card-body">
                              <h5 class="card-title font-weight-bold">{{p.name}}</h5>
                              <p class="card-text text-muted">
                                    <svg class="bi bi-check" width="1em" height="1em" viewBox="0 0 16 16"
                                          fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                          <path fill-rule="evenodd"
                                                d="M10.97 4.97a.75.75 0 0 1 1.071 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.236.236 0 0 1 .02-.022z" />
                                    </svg>{{p.description}}
                              </p>

                              {% for plan in p.plan_set.all %}
                              <!-- only read the last price given -->
                              {% if forloop.last %}
                              <h5>{{ plan.human_readable_price }}</h5>
                              <div class="text-right">
                                    <input type="checkbox" name="{{p.name}}" value="{{p.id}}"
                                          onclick="planSelect('{{p.name}}' ,'{{plan.human_readable_price}}', '{{plan.id}}')">
                                    {% endif %}
                                    {% endfor %}
                              </div>
                        </div>
                  </div>
            </div>
            {% endfor %}
      </div>
      <br><br>
      <hr><br><br>
      <div>
            <div class="row">
                  <div class="col-12">
                        <div class="card mx-5 shadow rounded">
                              <div class="card-body">
                                    <h5 class="card-title font-weight-bold">Checkout</h5>
                                    <p class="text-muted ">Enter card details. Your subscription will start immediately
                                    </p>
                                    <div class="row">
                                          <div class="col-6 text-muted">
                                                <p>Plan:</p>
                                                <p>Total:</p>
                                          </div>
                                          <div class="col-6 text-right">
                                                <p id="plan"></p>
                                                <p id="price"></p>
                                                <p hidden id="priceId"></p>
                                          </div>

                                    </div>
                                    <br>
                                    <form id="subscription-form">{% csrf_token %}
                                          <div id="card-element" class="MyCardElement">
                                                <!-- Elements will create input elements here -->
                                          </div>

                                          <!-- We'll put the error messages in this element -->
                                          <div id="card-errors" role="alert"></div>
                                          <button id="submit" type="submit">
                                                <div class="spinner-border  spinner-border-sm text-light hidden"
                                                      id="spinner" role="status">
                                                      <span class="sr-only">Loading...</span>
                                                </div>
                                                <span id="button-text">Subscribe</span>
                                          </button>
                                    </form>
                              </div>
                        </div>
                  </div>
            </div>
      </div>
      <br><br>
</div>
{% endblock %}

{% block style %}
<style>
      .container {
            width: 80%;
            margin: 0 auto;
      }

      .row {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-gap: 20px;
      }

      .col-6 {
            grid-column: span 6;
      }

      .col-12 {
            grid-column: span 12;
      }

      .card {
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
            transition: 0.3s;
            border-radius: 5px;
            padding: 20px;
            /* 5px rounded corners */
      }

      .card:hover {
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
      }

      hr {
            margin-top: 1rem;
            margin-bottom: 1rem;
            border: 0;
            border-top: 1px solid rgba(0, 0, 0, .1);
      }

      @media (max-width: 992px) {
            .col-s-12 {
                  grid-column: span 12;
            }
      }
</style>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<script>
      document.getElementById("submit").disabled = true;

      stripeElements();

      function stripeElements() {
            stripe = Stripe('{{ stripe_pub_key }}');

            if (document.getElementById('card-element')) {
                  let elements = stripe.elements();

                  // Card Element styles
                  let style = {
                        base: {
                              color: "#32325d",
                              fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                              fontSmoothing: "antialiased",
                              fontSize: "16px",
                              "::placeholder": {
                                    color: "#aab7c4"
                              }
                        },
                        invalid: {
                              color: "#fa755a",
                              iconColor: "#fa755a"
                        }
                  };


                  card = elements.create('card', { style: style });

                  card.mount('#card-element');

                  card.on('focus', function () {
                        let el = document.getElementById('card-errors');
                        el.classList.add('focused');
                  });

                  card.on('blur', function () {
                        let el = document.getElementById('card-errors');
                        el.classList.remove('focused');
                  });

                  card.on('change', function (event) {
                        displayError(event);
                  });
            }
            //we'll add payment form handling here
            let paymentForm = document.getElementById('subscription-form');
            if (paymentForm) {

                  paymentForm.addEventListener('submit', function (evt) {
                        evt.preventDefault();
                        changeLoadingState(true);


                        // create new payment method & create subscription
                        createPaymentMethod({ card });
                  });
            }
      }

      function displayError(event) {

            let displayError = document.getElementById('card-errors');
            if (event.error) {
                  displayError.textContent = event.error.message;
            } else {
                  displayError.textContent = '';
            }
      }

      function planSelect(name, price, priceId) {
            var inputs = document.getElementsByTagName('input');

            for (var i = 0; i < inputs.length; i++) {
                  inputs[i].checked = false;
                  if (inputs[i].name == name) {

                        inputs[i].checked = true;
                  }
            }

            var n = document.getElementById('plan');
            var p = document.getElementById('price');
            var pid = document.getElementById('priceId');
            n.innerHTML = name;
            p.innerHTML = price;
            pid.innerHTML = priceId;
            document.getElementById("submit").disabled = false;


      }

      function createPaymentMethod({ card }) {

            // Set up payment method for recurring usage
            let billingName = '{{user.username}}';

            stripe
                  .createPaymentMethod({
                        type: 'card',
                        card: card,
                        billing_details: {
                              name: billingName,
                        },
                  })
                  .then((result) => {
                        if (result.error) {
                              displayError(result);
                        } else {
                              const paymentParams = {
                                    price_id: document.getElementById("priceId").innerHTML,
                                    payment_method: result.paymentMethod.id,
                                    plan_id: document.getElementById("plan").innerHTML,
                              };
                              fetch("../create-sub", {
                                    method: 'POST',
                                    headers: {
                                          'Content-Type': 'application/json',
                                          "X-CSRFToken": Cookies.get('csrftoken')
                                    },
                                    credentials: 'same-origin',
                                    body: JSON.stringify(paymentParams),
                              }).then((response) => {
                                    return response.json();
                              }).then((result) => {
                                    if (result.error) {
                                          // The card had an error when trying to attach it to a customer
                                          throw result;
                                    }
                                    return result;
                              }).then((result) => {
                                    if (result && result.status === 'active') {

                                          window.location.href = '../complete';
                                    };
                              }).catch(function (error) {
                                    displayError(result.error.message);

                              });
                        }
                  });
      }


      var changeLoadingState = function (isLoading) {
            if (isLoading) {
                  document.getElementById("submit").disabled = true;
                  document.querySelector("#spinner").classList.remove("hidden");
                  document.querySelector("#button-text").classList.add("hidden");
            } else {
                  document.getElementById("submit").disabled = false;
                  document.querySelector("#spinner").classList.add("hidden");
                  document.querySelector("#button-text").classList.remove("hidden");
            }
      };
</script>
{% endblock %}